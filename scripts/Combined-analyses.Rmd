---
title: "Combined-Analyses"
author: "Shawn Cummings, Menghan Yang, and Florian Jaeger"
date: "\today"
geometry: margin=2cm
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '4'
  fontsize: 10pt
  pdf_document:
    fig_caption: yes
    fig_width: 7
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
    toc: yes
    toc_depth: 4
header-includes:
- \usepackage{booktabs}
- \usepackage{siunitx}
- \usepackage{tabto}
- \usepackage{soul}
- \usepackage{xcolor}
- \usepackage{placeins}
- \usepackage{lscape}
- \usepackage{animate}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \makeatletter\renewcommand{\fps@table}{!ht}\makeatother
- \setstcolor{red}
- \usepackage{sectsty}
- \sectionfont{\color{blue}}
- \subsectionfont{\color{blue}}
- \subsubsectionfont{\color{darkgray}}
---

```{r, include=FALSE}
library(knitr)

opts_chunk$set(dev = 'png',
               comment="", 
               echo=FALSE, warning=TRUE, message=TRUE,
               cache=FALSE, 
               size="small",
               tidy.opts = list(width.cutoff = 200),
               fig.width = 8, fig.height = 4.5, fig.align = "center")


def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})

color_block = function(color) {
  function(x, options) sprintf('\\color{%s}\\begin{verbatim}%s\\end{verbatim}\\color{black}',
                               color, x)
}
knitr::knit_hooks$set(error = color_block('red'))
knitr::knit_hooks$set(warning = color_block('orange'))
```

```{r, include=FALSE}
library(tidyverse)
library(magrittr)    # pipes
library(lubridate)   # date conversion, etc.

library(brms)        # Bayesian GL(M)Ms
library(sjPlot)      # tables for Bayesian GL(M)Ms
library(broom)       # extracting information from GL(M)Ms
library(lme4)        # Frequentist GLMMs
#library(linguisticsdown)  #IPA symbols
library(rstan)
#library(cmdstanr) # Not available for R 4.2.3?
library(boot)         # easy logit() function
```

```{r constants, include=FALSE}
source("constants.R")
```

# Data import and renaming

We import the formatted data frames from Norming Experiments A and B, as well as Experiment A and Experiment 1 from Liu & Jaeger 2018

```{r}
#rm(list = ls())

load("../data/Experiment-NORM-A-before-exclusions.RData") #named d.test.A
d.Exp1a <- d.test.A %>%
  mutate(Experiment = "CISP-1a")
 
load("../data/Experiment-NORM-B-before-exclusions.RData") #named d.test.B
d.Exp1b <- d.test.B %>%
  mutate(Experiment = "CISP-1b")

load("../data/Experiment-NORM-C-before-exclusions.RData") #named d.test.C
d.Exp1c <- d.test.C %>%
  mutate(Experiment = "CISP-1c")

d.Exp1 <- bind_rows(d.Exp1a, d.Exp1b, d.Exp1c) %>%
  rename(Participant.AudioType = Answer.audio_type,
         Talker.Sex = Answer.sex) %>%
  add_exclusions()

rm(d.test.A, d.test.B, d.test.C,
   d.Exp1a, d.Exp1b, d.Exp1c)

# load("../data/Experiment-NORM-D-before-exclusions.RData") #named d.test.D
# d.NormD.test <- d.test.D
# 
# load("../data/Experiment-NORM-E-before-exclusions.RData") #named d.test.E
# d.NormE.test <- d.test.E %>%
#   mutate(Participant.Age = as.double(Participant.Age))

d.LJ18.test <- read.csv("../data/Liu Jaeger 2018/Liu-Jaeger-2018-test-1-s2.0-S0010027718300118-mmc2.csv")

##MTurk Experiments we don't really care about
# load("../data/Experiment-A-before-exclusions.RData") #named d.A
# d.ExpA <- d.A %>%
#   mutate(Experiment = "ExpA")
# 
# load("../data/Experiment-B-before-exclusions.RData") #named d.B
# d.ExpB <- d.B.unexcluded %>%
#   mutate(Experiment = "ExpB")
# 
# load("../data/Experiment-C-before-exclusions.RData") #named d.C
# d.ExpC <- d.C.unexcluded %>%
#   mutate(Experiment = "ExpC")

load("../data/Experiment-2-before-exclusions.RData") #named d.Exp2
d.Exp2 %<>%
  rename(Participant.AudioType = audio_type,
         Talker.Sex = sex) %>%
  add_exclusions() %>%
  mutate(Experiment = "CISP-2")

load("../data/Experiment-3-before-exclusions.RData") #named d.Exp3
d.Exp3 %<>%
  rename(Participant.AudioType = audio_type,
         Talker.Sex = sex) %>%
  add_exclusions() %>%
  mutate(Experiment = "CISP-3")
```


Exclusion summaries
```{r}
d.Exp1.excluded <- d.Exp1 %>%
  group_by(ParticipantID) %>%
  filter(Exclude_Participant.Reason != "none") %>%
  select(Exclude_Participant.Reason, Experiment) %>%
  unique()

d.Exp2.excluded <- d.Exp2 %>%
  group_by(ParticipantID) %>%
  filter(Exclude_Participant.Reason != "none") %>%
  select(Exclude_Participant.Reason, Experiment) %>%
  unique()

d.Exp3.excluded <- d.Exp3 %>%
  group_by(ParticipantID) %>%
  filter(Exclude_Participant.Reason != "none") %>%
  select(Exclude_Participant.Reason, Experiment) %>%
  unique()

exclusion.summary <- bind_rows(d.Exp1.excluded,
                               d.Exp2.excluded,
                               d.Exp3.excluded)
exclusion.summary
rm(d.Exp1.excluded, d.Exp2.excluded, d.Exp3.excluded)
```


```{r}
## Create df for this:
d.Exp1.forExclusionSummary <- d.Exp1 %>%
  group_by(Experiment, ParticipantID) %>%
  mutate(Exclude_Participant.because_of_TOTAL = ifelse(Exclude_Participant.Reason != "none", T, F)) %>%
  select(starts_with("Exclude_Participant.because")) %>%
  distinct()

d.Exp2.forExclusionSummary <- d.Exp2 %>%
  group_by(Experiment, ParticipantID) %>%
  mutate(Exclude_Participant.because_of_TOTAL = ifelse(Exclude_Participant.Reason != "none", T, F)) %>%
  select(starts_with("Exclude_Participant.because")) %>%
  distinct()

d.Exp3.forExclusionSummary <- d.Exp3 %>%
  group_by(Experiment, ParticipantID) %>%
  mutate(Exclude_Participant.because_of_TOTAL = ifelse(Exclude_Participant.Reason != "none", T, F)) %>%
  select(starts_with("Exclude_Participant.because")) %>%
  distinct()

forExclusionSummary <- rbind(d.Exp1.forExclusionSummary,
                             d.Exp2.forExclusionSummary,
                             d.Exp3.forExclusionSummary)
#rm(d.Exp1.forExclusionSummary, d.Exp2.forExclusionSummary,d.Exp3.forExclusionSummary)

exclusionTable <- d.Exp1.forExclusionSummary %>%
  group_by(Experiment) %>%
  mutate(Recruited = length(unique(ParticipantID))) %>%
  group_by(Experiment, Recruited) %>%
  select(-ParticipantID) %>%
  summarise_all(
    function(x) { 
      paste0(
        sum(x),
        " (", 100 * round(sum(x) / length(x), 3), "%)") } ) %>% 
  mutate_all(~ gsub("NA", "0", .x)) %>%
  mutate_all(~ gsub("0 \\(0\\%\\)", "-", .x)) %>%
  # Sort columns
  select(
    Experiment,
    Recruited,
    #Exclude_Participant.because_of_TechnicalDifficulty,
    #Exclude_Participant.because_of_MultipleExperiments,
    Exclude_Participant.because_of_IgnoredInstructions,
    Exclude_Participant.because_of_CatchQuestion,
    #Exclude_Participant.because_of_CatchTrials,
    #Exclude_Participant.because_of_Accuracy.LexicalDecision.Normal,
    Exclude_Participant.because_of_SwappedKeys,
    Exclude_Participant.because_of_RT,
    Exclude_Participant.because_of_MissingTrials,
    Exclude_Participant.because_of_TOTAL) %>%
  rename_all(~ gsub("Exclude_Participant.because_of_", "", .x)) %>%
  t(.) %>%
  kable(
    label = "Exclusions")
exclusionTable
```


# Formatting LJ18 to include same column labels as other studies

```{r}
d.LJ18.formatted <- d.LJ18.test %>%
  filter(Condition == 'Filler',
         Trial < 13) %>%
  mutate(Experiment = 'LJ18',
         ParticipantID = as.numeric(Subject - 600), 
         Condition.Test.Audio = Step, 
         Condition.Test.Pen = 'Audio-Only',
         Condition.Test.OriginalLabel = 'Audio-Only',
         Condition.Exposure.Pen = '50-50',
         Condition.Exposure.LexicalLabel = 'N/A',
         Response =
           factor(case_when(
             Response == "SH" ~ "ASHI",
             Response == "S" ~ "ASI")),
         # Blocks were 6 trials rather than 12 in LJ18, and we have no need to keep track of them for our purposes here,
         # but for rbind to work we need a column for Block
         Block = 1) %>%
  select(Block, Experiment, Condition.Exposure.Pen, 
         Condition.Exposure.LexicalLabel, ParticipantID, Condition.Test.Audio, 
         Condition.Test.Pen, Response, Condition.Test.OriginalLabel)
summary(d.LJ18.test)
```

# Binding data

```{r}
# d.Norm.test <- bind_rows(d.NormA.test, 
#                          d.NormB.test, 
#                          d.NormC.test, 
#                          d.NormD.test, 
#                          d.NormE.test)

d.Exp1.formatted <- d.Exp1 %>%
  mutate(Condition.Exposure.Pen = 'H',
         Condition.Exposure.LexicalLabel = 'N/A',
         ParticipantID = as.numeric(ParticipantID)) %>%
  select(Block, Experiment, Condition.Exposure.Pen, 
         Condition.Exposure.LexicalLabel, ParticipantID, Condition.Test.Audio,
         Condition.Test.Pen, Response, Condition.Test.OriginalLabel)
summary(d.Exp1.formatted)

d.Exp2.formatted <- d.Exp2 %>%
  excludeData() %>%
  filter(Phase == 'test') %>%
  mutate(ParticipantID = as.numeric(ParticipantID)) %>%
  select(Block, Experiment, Condition.Exposure.Pen, 
         Condition.Exposure.LexicalLabel, ParticipantID, Condition.Test.Audio,
         Condition.Test.Pen, Response, Condition.Test.OriginalLabel)
summary(d.Exp2.formatted)


d.Exp3.formatted <- d.Exp3 %>%
  excludeData() %>%
  filter(Phase == 'test') %>%
  mutate(ParticipantID = as.numeric(ParticipantID)) %>%
  select(Block, Experiment, Condition.Exposure.Pen, 
         Condition.Exposure.LexicalLabel, ParticipantID, Condition.Test.Audio,
         Condition.Test.Pen, Response, Condition.Test.OriginalLabel)
summary(d.Exp3.formatted)

d.test <- rbind(d.Exp1.formatted,
                d.Exp2.formatted,
                d.Exp3.formatted,
                d.LJ18.formatted) %>%
  ungroup()
summary(d.test)

```

### some qc of the binding

```{r}
d.test %>%
  select(Experiment) %>%
  distinct()

d.test %>%
  select(Experiment, Condition.Test.Audio) %>%
  group_by(Experiment, Condition.Test.Audio) %>%
  unique()

#LJ18: 12, 14, 15 ,16 ,17, 19
#NORM A: 13, 15, 16, 17, 18, 20
#NORM B: 10, 13, 14, 15, 16, 20
#NORM C, D, E: 13, 17, 18, 19, 20, 24

save(d.test, 
  file =  "../data/Combined-Experiments-after-exclusions.RData")
```



# CISP-1 with LJ18 as a norm

```{r}
d.test %>%
  mutate(Family = case_when(
    Experiment %in% c("CISP-1a", "CISP-1b", "CISP-1c") ~ "CISP-1",
    T ~ Experiment)) %>%
  filter(Family %in% c("CISP-1", "LJ18"),
         Block == 1) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Test.Pen,
           Response, Family, Experiment) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Test.Pen,
      linetype = Experiment,
      shape = Experiment)) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.5)) +
  geom_smooth(
    mapping = aes(),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15) +
  scale_x_continuous("Phonetic continuum",
                     breaks = c(10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 24)) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  scale_color_manual("Presence of pen",
                        breaks = c("Audio-Only", "H", "M"),
                        labels = c("None (Audio-Only)", "Hand", "Mouth"),
                        values = c("Black", "#799E38", "#EEB649")) +
    scale_linetype_manual("Experiment",
                        values = c("dashed", "dashed", "solid", "solid")) +
  scale_shape_manual("Pen location",
                     values = c(1, 2, 0, 0)) +
  geom_hline(yintercept = .5) +
  labs(title = "Categorization responses for test-only, CISP-1 vs LJ18" )


# same, but collapsed across CISP-1 conditions
d.test %>%
  mutate(Family = case_when(
    Experiment %in% c("CISP-1a", "CISP-1b", "CISP-1c") ~ "CISP-1",
    T ~ Experiment)) %>%
  filter(Family %in% c("CISP-1", "LJ18"),
         Block == 1) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Test.Pen,
           Condition.Test.OriginalLabel,
           Response, Family, Experiment) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Test.OriginalLabel)) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.5)) +
  geom_smooth(
    mapping = aes(linetype = Condition.Test.Pen),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15) +
  scale_x_continuous("Phonetic continuum",
                     breaks = c(10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 24)) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  scale_color_manual("Presence of pen",
                        breaks = c("Audio-Only", "H", "M"),
                        labels = c("None (Audio-Only)", "Hand", "Mouth"),
                        values = c("Black", "#799E38", "#EEB649")) +
  geom_hline(yintercept = .5) +
  labs(title = "Categorization responses for test-only, CISP-1 vs LJ18" )

```

# Exp2 with Exp 1c as a norm

```{r}
# Create clone of 1c with Condition.Exposure.Pen = "M"
d.Exp1.Mclone <- d.Exp1.formatted %>%
  mutate(Condition.Exposure.Pen = "M")

d.Exp1vs2 <- rbind(d.test, d.Exp1.Mclone)

plot <- d.Exp1vs2 %>%
  mutate(Condition.Exposure.Pen2 = case_when(
    Condition.Exposure.Pen == "M" ~ "PIM Exposure",
    Condition.Exposure.Pen == "H" ~ "PIH Exposure",
  ),
  Condition.Test.Pen2 = case_when(
    Condition.Test.Pen == "M" ~ "PIM Test",
    Condition.Test.Pen == "H" ~ "PIH Test",
  )) %>%
  filter(Experiment %in% c("CISP-1c", "CISP-2"),
         Block == 1) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Exposure.Pen2, Condition.Test.Pen2,
           Response, Experiment, Condition.Exposure.LexicalLabel) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Exposure.LexicalLabel)) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.5)) +
  geom_smooth(
    mapping = aes(),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15) +
  scale_x_continuous("Phonetic continuum",
                     breaks = c(12, 13, 17, 18, 19, 20, 24)) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  scale_color_manual("Shift in Exposure",
                        breaks = c("N/A", "S", "SH"),
                        labels = c("Test-Only", "S-Bias", "SH-Bias"),
                        values = c("Black", "Red", "Blue")) +
  geom_hline(yintercept = .5) +
  facet_grid(Condition.Exposure.Pen2~Condition.Test.Pen2) +
  labs(title = "Categorization responses for test-only vs Exposure")

ggsave(plot, filename = "../figures/Exp1vs2.pdf", width = 8, height = 5)
```

# Exp3 with Exp 1c as a norm

```{r}
plot <- d.test %>%
  filter(Experiment %in% c("CISP-1c", "CISP-3"),
         Block == 1) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Test.Pen,
           Response, Experiment, Condition.Exposure.LexicalLabel) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Exposure.LexicalLabel)) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.5)) +
  geom_smooth(
    mapping = aes(),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15) +
  scale_x_continuous("Phonetic continuum",
                     breaks = c(12, 13, 17, 18, 19, 20, 24)) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  scale_color_manual("Shift in 1st Block of Exposure",
                        breaks = c("N/A", "S", "SH"),
                        labels = c("Test-Only", "S-Bias", "SH-Bias"),
                        values = c("Black", "Red", "Blue")) +
  geom_hline(yintercept = .5) +
  facet_grid(~Condition.Test.Pen) +
  labs(title = "Categorization responses for test-only vs 2-phase Exposure" )
plot
```

# Visualization of test phases for conditions/studies wherein exposure is nonexistant or unexpected to bias categorization

## Visualization of LJ18 fillers alone

```{r}
d.LJ18.test %>%
  group_by(ParticipantID, Condition.Test.Audio, Response) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI)) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.5)) +
  geom_smooth(
    mapping = aes(),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15) +
  scale_x_continuous("Phonetic continuum",
                     breaks = c(13, 14, 15, 16, 17, 18, 20)) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  labs(title = "Categorization responses LJ18, fillers only condition" )
```


## Categorization visualization for NormC and LJ18 filler only

```{r}
# make a double for collapsing

d.Exp1comparison <- bind_rows(d.test %>%
                                filter(Experiment %in% c("CISP-1a", "CISP-1b", "CISP-1c")) %>%
                                mutate(Family = "CISP-1-Merged"),
                              d.test %>%
                                filter(Experiment %in% c("CISP-1a", "CISP-1b", "CISP-1c")) %>%
                                mutate(Family = Experiment))

d.Exp1comparison %>%
  filter(Block == 1) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Test.Pen, 
           Condition.Test.OriginalLabel, Family) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Test.OriginalLabel)) +
  geom_smooth(
    mapping = aes(linetype = Condition.Test.Pen,
                  fill = Condition.Test.OriginalLabel,
                  alpha = Family),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15,
    fullrange = T) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.4),
                mapping = aes(shape = Condition.Test.Pen)) +
  scale_x_continuous("Phonetic continuum",
                     breaks = c(10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 24)) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  scale_color_manual("Original Video Label",
                     breaks = c("S", "SH"),
                     labels = c("S", "SH"),
                     values = c("#799E38", "#EEB649")) +
    scale_fill_manual("Original Video Label",
                     breaks = c("S", "SH"),
                     labels = c("S", "SH"),
                     values = c("#799E38", "#EEB649")) +
  scale_linetype_manual("Pen location",
                        breaks = c("H", "M"),
                        labels = c("Hand", "Mouth"),
                        values = c("solid", "dotted")) +
  scale_shape_manual("Pen location",
                     breaks = c("H", "M"),
                     labels = c("Hand", "Mouth"),
                     values = c(0, 1)) +
  geom_hline(yintercept = 0.5, alpha = 0.5) +
  facet_wrap(~Family, nrow = 2)

#ggsave(filename = "../figures/categorization-by-pen-location-and-vis-label-in-test.pdf", width = 9, height = 8)
```

### Baseline vs norms, collapsed across continuum
```{r}
d.Exp1comparison %>%
  group_by(ParticipantID, Condition.Test.Pen, 
           Condition.Test.OriginalLabel, Family, Block) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = Block, 
      y = Response.ProportionASHI,
      color = Condition.Test.OriginalLabel)) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.4),
                mapping = aes(shape = Condition.Test.Pen)) +
  stat_summary(fun.data = mean_cl_boot, geom = "line", position = position_dodge(.4),
                mapping = aes(linetype = Condition.Test.Pen)) +
    scale_y_continuous("Proportion of ASHI responses") +
  scale_color_manual("Original Video Label",
                     breaks = c("S", "SH", "Audio-Only"),
                     labels = c("S", "SH", "None; Audio-Only"),
                     values = c("#799E38", "#EEB649", "black")) +
  scale_shape_manual("Pen location",
                     breaks = c("H", "M", "Audio-Only"),
                     labels = c("Hand", "Mouth", "None; Audio-Only"),
                     values = c(0, 1, 2)) +
    scale_linetype_manual("Pen location",
                        breaks = c("H", "M"),
                        labels = c("Hand", "Mouth"),
                        values = c("solid", "dotted")) +
  #geom_hline(yintercept = 0, alpha = 0.5) +
  facet_wrap(~Family)
  
  
```

## Replicate LJ18 Figure (collapsing across block, showing different conditions of Exp2 vs baseline)
```{r}

plot <- d.test %>%
  filter(Experiment %in% c("CISP-1c", "CISP-2"),
         Block == 1) %>%
  mutate(Condition = paste(Condition.Exposure.Pen, Condition.Test.Pen, sep = ", Test: ")
  ) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition,
           Response, Experiment, Condition.Exposure.LexicalLabel) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = Condition, 
      y = Response.ProportionASHI,
      color = Condition.Exposure.LexicalLabel)) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = dodge(.03)) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  scale_color_manual("Shift in Exposure",
                        breaks = c("N/A", "S", "SH"),
                        labels = c("Test-Only", "S-Bias", "SH-Bias"),
                        values = c("Black", "Red", "Blue"))
plot(plot)

#ggsave(plot, filename = "../figures/Exp1vs2.pdf", width = 8, height = 5)
```






## NormD vs NormE

```{r}
d.test %>%
  filter(Experiment != 'ExpA',
         Experiment != 'ExpB',
         Experiment != 'NORM A',
         Experiment != 'NORM B',
         Experiment != 'LJ18',
         Experiment != 'NORM C',
         Block == 1
  ) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Test.Pen, Experiment) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Experiment)) +
  geom_smooth(
    mapping = aes(linetype = Condition.Test.Pen),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15,
    fullrange = T) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.4),
               mapping = aes(shape = Condition.Test.Pen)) +
  scale_x_continuous("Phonetic continuum",
                     breaks = c(13, 17, 18, 19, 20, 24),
                      labels = c("13\nMost /s/-like", "17", "18", "19", "20", "24\nMost /ʃ/-like")) +
  scale_y_continuous("Proportion of /ɑʃi/ responses", limits = c(0,1)) +
  scale_color_manual("Experiment",
                     breaks = c("NORM D", "NORM E"),
                     labels = c("Norm D", "Norm E"),
                     values = c("#EEB649", 'black')) +
  scale_linetype_manual("Pen location",
                        breaks = c("H", "M"),
                        labels = c("Hand", "Mouth"),
                        values = c("solid", "dashed")) +
  scale_shape_manual("Pen location",
                     breaks = c("H", "M"),
                     labels = c("Hand", "Mouth"),
                     values = c("circle", "square")) +
  theme(aspect.ratio = 2/3) 

ggsave(filename = "../figures/Norms-D-&-E.jpeg", width = 8, height = 5)
```

## Categorization visualization for NormD compared to NormC

```{r}
d.test %>%
  filter(Experiment != 'ExpA',
         Experiment != 'ExpB',
         Experiment != 'NORM A',
         Experiment != 'NORM B',
         Experiment != 'NORM E',
         Experiment != 'LJ18',
         Block == 1
  ) %>%
  mutate(Condition.Test.Occluder =
           ifelse(Experiment == 'NORM D', 'occluded',
                  ifelse(Experiment == 'NORM E', 'occluded',
                         Condition.Test.OriginalLabel))) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Test.Pen, Condition.Test.Occluder) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Test.Occluder)) +
  geom_smooth(
    mapping = aes(linetype = Condition.Test.Pen),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15,
    fullrange = T) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.4),
               mapping = aes(shape = Condition.Test.Pen)) +
  scale_x_continuous("Phonetic continuum step",
                     breaks = c(13, 17, 18, 19, 20, 24),
labels = c("13\nMost /s/-like", "17", "18", "19", "20", "24\nMost /ʃ/-like")) +
  scale_y_continuous("Proportion of /ɑʃi/ responses", limits = c(0,1)) +
  scale_color_manual("Original Video Label",
                     breaks = c("1", "2", "occluded"),
                     labels = c("/s/ (Norm C)", "/ʃ/ (Norm C)", "occluded (Norm D)"),
                     values = c("#799E38", "#EEB649", 'black')) +
  scale_linetype_manual("Pen location",
                        breaks = c("H", "M"),
                        labels = c("Hand", "Mouth"),
                        values = c("solid", "dashed")) +
  scale_shape_manual("Pen location",
                     breaks = c("H", "M"),
                     labels = c("Hand", "Mouth"),
                     values = c("circle", "square")) +
  labs(title = "Phonetic categorization in occluded vs non-occluded test") +
  theme(aspect.ratio = 3/4)

ggsave(filename = "../figures/Phonetic-categorization-in-occluded-vs-non-occluded-test.jpeg", width = 8, height = 5)
```

#NormC alone (but formatted like above) This can be used for any combination of norming studies

```{r}
d.test %>%
  filter(Experiment != 'ExpA',
         Experiment != 'ExpB',
         Experiment != 'NORM A',
         Experiment != 'NORM B',
         Experiment != 'NORM E',
         Experiment != 'NORM D',
         Experiment != 'LJ18',
         Block == 1
  ) %>%
  # mutate(Condition.Test.Occluder =
  #          ifelse(Experiment == 'NORM D', 'occluded',
  #                 ifelse(Experiment == 'NORM E', 'occluded',
  #                        Condition.Test.OriginalLabel))) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Test.Pen, Condition.Test.OriginalLabel) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Test.Pen)) +
  geom_smooth(
    mapping = aes(linetype = Condition.Test.Pen),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15,
    fullrange = T) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.4),
               mapping = aes(shape = Condition.Test.Pen)) +
  scale_x_continuous("Phonetic continuum step",
                     breaks = c(13, 17, 18, 19, 20, 24),
                      labels = c("13\nMost /s/-like", "17", "18", "19", "20", "24\nMost /ʃ/-like")) +
  scale_y_continuous("Proportion of /ɑʃi/ responses", limits = c(0,1)) +
  scale_color_manual("Pen location",
                     breaks = c("H", "M"),
                     labels = c("Hand", "Mouth"),
                     values = c("#799E38", "#EEB649")) +
  scale_linetype_manual("Pen location",
                        breaks = c("H", "M"),
                        labels = c("Hand", "Mouth"),
                        values = c("solid", "dashed")) +
  scale_shape_manual("Pen location",
                     breaks = c("H", "M"),
                     labels = c("Hand", "Mouth"),
                     values = c("circle", "triangle")) +
  labs(title = "Phonetic categorization in norming experiment C") +
  theme(aspect.ratio = 3/4) +
  theme(legend.position = "top")

ggsave(filename = "../figures/Phonetic-categorization-in-NormC.pdf", width = 8, height = 5)
```

## Categorization visualization for NormD compared to NormC

```{r}
d.test %>%
  filter(Experiment != 'ExpA',
         Experiment != 'LJ18'
  ) %>%
  mutate(Condition.Test.Occluder =
           ifelse(Experiment == 'NORM D', 'occluded',
                  ifelse(Experiment == 'NORM E', 'occluded',
                         Condition.Test.OriginalLabel))) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Test.Pen, Condition.Test.Occluder) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Test.Occluder)) +
  geom_smooth(
    mapping = aes(linetype = Condition.Test.Pen),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15,
    fullrange = T) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.4),
               mapping = aes(shape = Condition.Test.Pen)) +
  scale_x_continuous("Phonetic continuum step",
                     breaks = c(10, 13, 14, 15, 16, 17, 18, 19, 20, 24)) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  scale_color_manual("Original Video Label",
                     breaks = c("1", "2", "occluded"),
                     labels = c("S (Norms A,B,C)", "SH (Norms A,B,C)", "occluded (Norms D,E)"),
                     values = c("#799E38", "#EEB649", 'black')) +
  scale_linetype_manual("Pen location",
                        breaks = c("H", "M"),
                        labels = c("Hand", "Mouth"),
                        values = c("solid", "dashed")) +
  scale_shape_manual("Pen location",
                     breaks = c("H", "M"),
                     labels = c("Hand", "Mouth"),
                     values = c("circle", "square")) +
  labs(title = "Phonetic categorization in occluded vs non-occluded test")

ggsave(filename = "../figures/all-five-norms.pdf", width = 8, height = 5)
```

## Categorization visualization for NormA, NormB, and NormC (not broken by og vis label)

```{r}
d.test %>%
  filter(Experiment != 'ExpA',
         Experiment != 'ExpB',
         #Experiment != 'NORM A',
         #Experiment != 'NORM B',
         #Experiment != 'NORM C',
         Experiment != 'NORM E',
         Experiment != 'NORM D',
         Experiment != 'LJ18',
         Block == 1) %>%
  group_by(ParticipantID, Condition.Test.Audio, Condition.Test.Pen) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Test.Pen,
      linetype = Condition.Test.Pen)) +
  geom_smooth(
    mapping = aes(linetype = Condition.Test.Pen),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .35,
    fullrange = T) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.4),
                mapping = aes(shape = Condition.Test.Pen)) +
  scale_x_continuous("Acoustic continuum",
                     breaks = c(10, 13, 14, 15, 16, 17, 18, 19, 20, 24),
                    labels = c("Most /s/-like", "", "","", "","", "", "", "", "Most /sh/-like")) +
  scale_y_continuous("Proportion of \"ashi\" responses", limits = c(0,1)) +
  scale_linetype_manual("Pen location\n(test)",
                        breaks = c("H", "M"),
                        labels = c("Hand", "Mouth"),
                        values = linetypes.test.pen_locations) +
   scale_color_manual("Pen location\n(test)",
                     breaks = c("H", "M"),
                     labels = c("Hand", "Mouth"),
                     values = c("#799E38", "#EEB649")) +
  scale_shape_manual(
    "Pen location\n(test)",
     breaks = c("H", "M"),
     labels = c("Hand", "Mouth"),
     values = c("circle", "triangle")) +
  theme(aspect.ratio = 4/7) +
  labs(title = "Categorizations along \"asi\"-\"ashi\" continuum" )

ggsave(filename = "../figures/categorization-by-pen-location-in-norm-a-to-c-test.pdf", width = 6, height = 6)
```

## Categorization visualization for NormA and NormB, for Block 1 only

```{r}
d.test %>%
  filter(Experiment != 'ExpA',
         Experiment != 'LJ18',
         Block == 1) %>%
  group_by(Experiment, ParticipantID, Condition.Test.Audio) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI)) +
  geom_smooth(
    mapping = aes(),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15,
    fullrange = T) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.2)) +
  scale_x_continuous("Phonetic continuum",
                     breaks = c(10, 13, 14, 15, 16, 17, 18, 20)) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  theme(aspect.ratio = 2/3)+
  geom_hline(yintercept = .25) +
  geom_hline(yintercept = .5) +
  geom_hline(yintercept = .75)

ggsave(filename = "../figures/categorization-NormA-and-NormB-Block1.pdf",width = 8, height = 10)

d.test %>%
  filter(Experiment != 'ExpA',
         Experiment != 'LJ18',
         Block == 1) %>%
  group_by(Experiment, ParticipantID, Condition.Test.Audio) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  glm(Response.ProportionASHI ~ as.numeric(as.character(Condition.Test.Audio)), 
      data = .,
      family = binomial) ->
  glm.NormA.and.NormB

summary(glm.NormA.and.NormB)

coef(glm.NormA.and.NormB)

tibble(x = 31:1, y = plogis(coef(glm.NormA.and.NormB)[1] + c(1:31) * coef(glm.NormA.and.NormB)[2]))
```

## First analyses for ExpC

```{r}
d.ExpC %>%
  group_by(ParticipantID) %>%
  mutate(PracticeTrials =
           sum(ifelse(Phase == 'practice', 1, 0))) %>%
  group_by(ParticipantID, PracticeTrials) %>%
  ggplot(
    aes(
      x = PracticeTrials)) +
  geom_density() +
  geom_vline(xintercept = 4)


```

## four-panel Categorization visualization for ExpB

```{r}
d.B.unexcluded %>%
  filter(Experiment == 'ExpB')


d.ExpC %>%
  select(ParticipantID, Answer.speaker) %>%
  filter(Answer.speaker != "")
  unique()

d.ExpC %>%
  group_by(ParticipantID) %>%
  mutate(PracticeTrials =
           sum(ifelse(Phase == 'practice', 1, 0)),
         CatchTrials = sum(Response.CatchTrial)) %>%
  select(ParticipantID, PracticeTrials, CatchTrials, Categorization.Slope) %>%
  unique()
  summary()

  filter(PracticeTrials < 13,
         Phase == 'test') %>%
  filter(Condition.Test.Pen != 'NA') %>%
  group_by(ParticipantID,
           Condition.Test.Audio, 
           Condition.Exposure.Pen, 
           Condition.Exposure.LexicalLabel,
           Condition.Test.Pen) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Exposure.LexicalLabel)) +
  facet_grid(Condition.Test.Pen ~ Condition.Exposure.Pen,
             labeller = label_both) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange") +
  geom_smooth(
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial")) +
  scale_x_continuous("Phonetic continuum") +
  scale_y_continuous("Proportion of \"ashi\"responses", limits = c(0,1))

d %>%
  excludeData() %>%
  group_by(ParticipantID,Condition.Test.Audio, Condition.Test.OriginalLabel, Condition.Test.Pen) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Test.OriginalLabel)) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.7)) +
  geom_smooth(
    mapping = aes(
      linetype = Condition.Test.Pen),
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial"),
    alpha = .15) +
  scale_x_continuous("Acoustic continuum",
                     breaks = c(13,24),
                     labels = c("more \"s\"-like","more \"sh\"-like" )) +
  scale_y_continuous("Proportion of \"ashi\"responses", limits = c(0,1)) +
  scale_color_manual(
    "Visual label",
    breaks = c("S", "SH"),
    labels = c("/s/", "/ʃ/"),
    values = c("#799E38", "#EEB649")) +
  scale_linetype_manual(
    "Pen location\n(test)",
    breaks = levels.test.pen_locations,
    labels = labels.test.pen_locations,
    values = linetypes.test.pen_locations) +
 labs(title = "Categorizations along \"asi\"-\"ashi\" continuum" )
  
```

### Vis. effect in ExpA, B, and Pilot C

```{r}
d.test %>%
  select(Experiment) %>%
  unique




```

##hh

```{r}
d %>%
  excludeData() %>%
  group_by(ParticipantID, ItemID, Condition.Test.OriginalLabel, Condition.Test.Pen) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(aes(
    x = ItemID, 
    y = Response.ProportionASHI,
    color = Condition.Test.OriginalLabel,
    linetype = Condition.Test.Pen)) +
  stat_summary(
    fun.data = mean_cl_boot, geom = "pointrange"
  ) +
  scale_x_discrete("Video frame") +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  scale_color_manual(
    "Visual label\n(test)",
    breaks = levels.test.visual_labels,
    labels = labels.test.visual_labels,
    values = c("#799E38", "#EEB649")) +
  scale_linetype_manual(
    "Pen location\n(test)",
    breaks = levels.test.pen_locations,
    labels = labels.test.pen_locations,
    values = linetypes.test.pen_locations) +
  scale_shape_manual(
    "Pen location\n(test)",
    breaks = levels.test.pen_locations,
    labels = labels.test.pen_locations,
    values = shapes.test.pen_locations)
```

# Visualization of test phase for ExpA, using aggregate of NormA and NormB as baseline

## Doubling the NormA and NormB data to account for both potential pen conditions

This is almost certainly a terrible idea, but I don't know how to do it right.

```{r}
d.Norm.test.Mhack <- d.Norm.test %>%
  mutate(Condition.Exposure.Pen = 'M')

d.test <- rbind(d.test, d.Norm.test.Mhack)
```

## Visualization of first 3 test blocks

```{r}
#character vectors for panel labels
testconditions <- as_labeller(c('H' = "Pen in hand during test",'M' = "Pen in mouth during test"))
exposureconditions <- as_labeller(c('H' = "Pen in hand during exposure",'M' = "Pen in mouth during exposure"))

d.test %>%
  filter(Experiment != 'LJ18') %>%
  group_by(ParticipantID, 
           Condition.Exposure.Pen, Condition.Exposure.LexicalLabel,
           Condition.Test.Audio, Condition.Test.Pen) %>%
  filter(Block <= 3) %>%
  summarise(Response.ProportionASHI = mean(ifelse(Response == "ASHI", 1, 0))) %>%
  ggplot(
    aes(
      x = as.numeric(as.character(Condition.Test.Audio)), 
      y = Response.ProportionASHI,
      color = Condition.Exposure.LexicalLabel)) +
  geom_smooth(
    formula = y ~ x, 
    method = "glm", 
    method.args = list(family = "binomial")) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(.2), alpha = .5) +
  scale_x_continuous("Phonetic continuum", breaks = c()) +
  scale_y_continuous("Proportion of ASHI responses", limits = c(0,1)) +
  scale_color_manual(
    "Lexical label (exposure)",
    breaks = c("S", "SH", "N/A"),
    labels = c("'s'", "'sh'", "N/A"),
    values = c("red", "blue", "black")) +
  facet_grid(Condition.Exposure.Pen ~ Condition.Test.Pen, 
             labeller = labeller(Condition.Test.Pen = testconditions,
                                 Condition.Exposure.Pen = exposureconditions)) +
  theme(legend.position = "top")+
  theme(aspect.ratio = 2/3)

ggsave(filename = "../figures/ExpA-with-baseline.pdf",width = 10, height = 10)
```

# Analysis!
```{r}
# Set priors for all analyses
priors <- c(
    prior(student_t(3,0,2.5), class = b),
    prior(cauchy(0,5), class = sd), 
    prior(lkj(1), class = cor))
```

## Exp1
```{r}
# Prep dataframe for analyses of Exp1
d.Exp1.analysis <- d.test %>%
  select(!Condition.Exposure.LexicalLabel) %>%
  filter(Experiment %in% c("CISP-1a", "CISP-1b", "CISP-1c")) %>%
            mutate(
              Condition.Test.Pen = 
                "contrasts<-"(factor(Condition.Test.Pen), , c(-0.5, 0.5)),
              Condition.Test.OriginalLabel = 
                "contrasts<-"(factor(Condition.Test.OriginalLabel), , c(0.5, -0.5)),
              Block = Block - 1)

# Check that the contrasts are what we want them to be
contrasts(d.Exp1.analysis$Condition.Test.Pen) 
# H = -0.5, M = 0.5
contrasts(d.Exp1.analysis$Condition.Test.OriginalLabel) 
# SH = -0.5, S = 0.5
```
### Experiment 1a
```{r}

# Simplest model, no random effects and no effect of step yet
d.Exp1a.brm <- brm(
  ifelse(Response == "ASHI", 1, 0) ~
    1 + Condition.Test.OriginalLabel * Condition.Test.Pen * Block +
    (1 | ParticipantID),
  data = d.Exp1.analysis %>%
    filter(Experiment == "CISP-1a"),
  family = "bernoulli",
  prior = priors,
  #backend = "cmdstanr",
  cores = min(parallel::detectCores(), 8), 
  chains = 4, warmup = 1000, iter = 1000)
summary(d.Exp1a.brm)

# Full model with all the things we care about!
d.Exp1a.brm.full <- brm(
  ifelse(Response == "ASHI", 1, 0) ~
    1 + Condition.Test.OriginalLabel * Condition.Test.Pen * Block * mo(Condition.Test.Audio) +
    (1 + Condition.Test.OriginalLabel * Condition.Test.Pen * Block * mo(Condition.Test.Audio) | ParticipantID),
  data = d.Exp1.analysis %>%
    filter(Experiment == "CISP-1a"),
  family = "bernoulli",
  prior = priors,
  #backend = "cmdstanr",
  cores = min(parallel::detectCores(), 8), 
  chains = 4, warmup = 1000, iter = 1000)
summary(d.Exp1a.brm.full)
```

### Experiment 1b
```{r}

# Simplest model, no random effects and no effect of step yet
d.Exp1b.brm <- brm(
  ifelse(Response == "ASHI", 1, 0) ~
    1 + Condition.Test.OriginalLabel * Condition.Test.Pen * Block +
    (1 | ParticipantID),
  data = d.Exp1.analysis %>%
    filter(Experiment == "CISP-1b"),
  family = "bernoulli",
  prior = priors,
  #backend = "cmdstanr",
  cores = min(parallel::detectCores(), 8), 
  chains = 4, warmup = 1000, iter = 1000)
summary(d.Exp1b.brm)

# Full model with all the things we care about!
d.Exp1b.brm.full <- brm(
  ifelse(Response == "ASHI", 1, 0) ~
    1 + Condition.Test.OriginalLabel * Condition.Test.Pen * Block * mo(Condition.Test.Audio) +
    (1 + Condition.Test.OriginalLabel * Condition.Test.Pen * Block * mo(Condition.Test.Audio) | ParticipantID),
  data = d.Exp1.analysis %>%
    filter(Experiment == "CISP-1b"),
  family = "bernoulli",
  prior = priors,
  #backend = "cmdstanr",
  cores = min(parallel::detectCores(), 8), 
  chains = 4, warmup = 1000, iter = 1000)
summary(d.Exp1b.brm.full)
```

### Experiment 1c
```{r}
# Simplest model, no random effects and no effect of step yet
d.Exp1c.brm <- brm(
  ifelse(Response == "ASHI", 1, 0) ~
    1 + Condition.Test.OriginalLabel * Condition.Test.Pen * Block +
    (1 | ParticipantID),
  data = d.Exp1.analysis %>%
    filter(Experiment == "CISP-1c"),
  family = "bernoulli",
  prior = priors,
  #backend = "cmdstanr",
  cores = min(parallel::detectCores(), 8), 
  chains = 4, warmup = 1000, iter = 1000)
summary(d.Exp1c.brm)

# Full model with all the things we care about!
d.Exp1a.brm.full <- brm(
  ifelse(Response == "ASHI", 1, 0) ~
    1 + Condition.Test.OriginalLabel * Condition.Test.Pen * Block * mo(Condition.Test.Audio) +
    (1 + Condition.Test.OriginalLabel * Condition.Test.Pen * Block * mo(Condition.Test.Audio) | ParticipantID),
  data = d.Exp1.analysis %>%
    filter(Experiment == "CISP-1a"),
  family = "bernoulli",
  prior = priors,
  #backend = "cmdstanr",
  cores = min(parallel::detectCores(), 8), 
  chains = 4, warmup = 1000, iter = 1000)
summary(d.Exp1a.brm.full)
```







### Frequentist to check my syntax
```{r}
d.frequentist <- d.Exp1.analysis %>%
  mutate(Experiment = 
                "contrasts<-"(factor(Experiment), , contr.sum(3)),
         Condition.Test.Audio = scale(Condition.Test.Audio))
  # Frequentist doesn't have the convienient mo() function, I don't know if
  # scale() is any better than just leaving it numeric?

d.Exp1.glmer <- glmer(
  ifelse(Response == "ASHI", 1, 0) ~
    1 + Condition.Test.OriginalLabel * 
    Condition.Test.Pen * 
    Condition.Test.Audio * 
    Block *
    Experiment +
    (1 + 
       Condition.Test.OriginalLabel * 
       Condition.Test.Pen * 
       Condition.Test.Audio * 
       Block *
       Experiment |
        ParticipantID),
  data = d.frequentist,
  family = "binomial",
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 800000))
)
summary(d.Exp1.glmer)

```

